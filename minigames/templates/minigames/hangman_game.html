{% extends "base.html" %}
{% load static %}
{% block title %}Ahorcado | RELACIONA{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container mt-4" style="max-width: 600px;">
  <div class="text-center mb-4 animate-slide-up">
    <div class="d-inline-flex align-items-center px-4 py-2 bg-white rounded-pill shadow-sm border">
      <span class="text-muted small fw-bold text-uppercase me-2">Puntuaci√≥n</span>
      <span class="fw-bold fs-5 text-primary">
        <i class="fas fa-star text-warning me-1"></i> 
        <span id="score-correct">{{ correct }}</span> / <span id="score-total">{{ total }}</span>
      </span>
    </div>
  </div>

  <div class="card card-glass shadow-lg border-0 animate-slide-up">
    <div class="card-body p-4 text-center">
      <h3 class="mb-4 fw-bold text-primary">Ahorcado</h3>

      <div class="mb-4 position-relative d-inline-block">
        <div class="rounded-circle shadow-glow p-1 bg-white border">
          {% if current_student.profile_picture %}
          <img src="{{ current_student.profile_picture.url }}" class="rounded-circle object-fit-cover"
            style="width: 140px; height: 140px; border: 4px solid #0d6efd;" alt="Alumno">
          {% else %}
          <div class="bg-light rounded-circle d-flex align-items-center justify-content-center mx-auto"
            style="width: 140px; height: 140px;">
            <i class="fas fa-user fa-4x text-muted opacity-25"></i>
          </div>
          {% endif %}
        </div>
      </div>

      <div class="mb-4">
        <div class="d-flex justify-content-between mb-1">
          <span class="text-muted small fw-bold">INTENTOS</span>
          <span id="attempts-text" class="fw-bold">{{ incorrect_count }}/{{ max_incorrect }}</span>
        </div>
        <div class="progress" style="height: 10px;">
          <div id="hangman-progress-bar" class="progress-bar bg-success" role="progressbar" 
               style="width: {% widthratio incorrect_count max_incorrect 100 %}%"></div>
        </div>
      </div>

      <div class="mb-5">
        <h2 id="word-display" class="text-primary fw-bold font-monospace display-6" style="letter-spacing: 0.15em;">
          {{ displayed_name }}
        </h2>
      </div>

      <div id="input-area">
          <div class="d-flex flex-wrap justify-content-center gap-2" id="keyboard">
            {% for letter in alphabet %}
              <button type="button" 
                id="btn-{{ letter }}"
                onclick="submitLetter('{{ letter }}')"
                class="btn btn-outline-primary fw-bold shadow-sm {% if letter in used_letters %}disabled-letter{% endif %}"
                style="width: 42px; height: 42px;"
                {% if letter in used_letters or game_over %}disabled{% endif %}>
                {{ letter }}
              </button>
            {% endfor %}
          </div>
      </div>

    </div>
  </div>

  <div class="text-center mt-4 mb-5">
    <a href="{% url 'group_detail' group.id %}" class="btn btn-link text-muted text-decoration-none">
      <i class="fas fa-arrow-left me-2"></i> Volver a la clase
    </a>
  </div>
</div>

<style>
  .disabled-letter { opacity: 0.3 !important; pointer-events: none; background-color: #f8f9fa !important; color: #dee2e6 !important; }
  .font-monospace { letter-spacing: 0.3em !important; }
</style>

<script>
function submitLetter(letter) {
    const formData = new FormData();
    formData.append('action', 'guess_letter');
    formData.append('letter', letter);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    const btn = document.getElementById('btn-' + letter);
    if(btn) btn.disabled = true;

    fetch("{% url 'hangman_game' group.id %}", {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('word-display').innerText = data.displayed_name;
        document.getElementById('attempts-text').innerText = `${data.incorrect_count}/${data.max_incorrect}`;
        
        const progress = (data.incorrect_count / data.max_incorrect) * 100;
        const progressBar = document.getElementById('hangman-progress-bar');
        progressBar.style.width = progress + '%';
        
        if(progress > 60) progressBar.className = "progress-bar bg-danger";

        if (data.game_over) {
            // Actualizar marcador final
            document.getElementById('score-correct').innerText = data.correct;
            document.getElementById('score-total').innerText = data.total;

            setTimeout(() => {
                Swal.fire({
                    title: data.won ? '¬°Lo lograste! üéâ' : '¬°Oh no! üòµ',
                    text: data.won ? 'Has adivinado el nombre.' : `El nombre era: ${data.target_name}`,
                    icon: data.won ? 'success' : 'error',
                    confirmButtonText: 'Siguiente Alumno',
                    confirmButtonColor: '#0d6efd',
                    allowOutsideClick: false
                }).then(() => {
                    window.location.reload(); // Esto ahora s√≠ elegir√° un nuevo alumno
                });
            }, 300);
        }
    });
}
</script>
{% endblock %}