{% extends "base.html" %}
{% load static %}
{% block title %}Ahorcado | RELACIONA{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container mt-4" style="max-width: 600px;">

  <div class="text-center mb-4 animate-slide-up">
    <div class="d-inline-flex align-items-center px-4 py-2 bg-white rounded-pill shadow-sm border">
      <span class="text-muted small fw-bold text-uppercase me-2" style="letter-spacing: 1px;">PuntuaciÃ³n</span>
      <span id="score-display" class="fw-bold fs-5 text-primary">
        <i class="fas fa-star text-warning me-1"></i> {{ correct }} / {{ total }}
      </span>
    </div>
  </div>

  <div class="card card-glass shadow-lg border-0 animate-slide-up delay-100">
    <div id="game-container" class="card-body p-4 text-center">

      <h3 class="mb-4 fw-bold font-heading text-primary d-flex align-items-center justify-content-center gap-2">
        <span class="badge bg-primary rounded-pill p-2"><i class="fas fa-gamepad"></i></span>
        Ahorcado
      </h3>

      <div class="mb-4 position-relative d-inline-block animate-float">
        <div class="rounded-circle shadow-glow p-1 bg-white border">
          {% if current_student.profile_picture %}
          <img src="{{ current_student.profile_picture.url }}" class="rounded-circle object-fit-cover"
            style="width: 140px; height: 140px; border: 4px solid white;" alt="Foto del alumno">
          {% else %}
          <div class="bg-light rounded-circle d-flex align-items-center justify-content-center mx-auto"
            style="width: 140px; height: 140px; border: 4px solid white;">
            <i class="fas fa-user fa-4x text-muted opacity-25"></i>
          </div>
          {% endif %}
        </div>
      </div>

      <div class="card border-0 bg-light mb-4 shadow-inner rounded-4 overflow-hidden">
        <div class="card-body py-3 px-4">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <span class="text-muted small fw-bold text-uppercase">Intentos Fallidos</span>
            <span id="attempts-text" class="fw-bold text-dark">{{ incorrect_count }}/{{ max_incorrect }}</span>
          </div>

          <div class="progress" style="height: 12px; border-radius: 10px; background-color: #e2e8f0;">
            {% with used=incorrect_count max=max_incorrect %}
            {% widthratio used max 100 as percentage %}
            <div id="hangman-progress-bar"
              class="progress-bar progress-bar-striped progress-bar-animated {% if percentage|add:'0' > 70 %}bg-danger{% else %}bg-success{% endif %}"
              role="progressbar" style="width: {{ percentage }}%; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);"
              aria-valuenow="{{ used }}" aria-valuemin="0" aria-valuemax="{{ max }}"></div>
            {% endwith %}
          </div>

          <div id="status-emoji" class="mt-2 fw-bold fs-4 animate-scale-in keyframe-bounce">
            {% if incorrect_count >= max_incorrect %}ðŸ˜µ{% elif incorrect_count >= 1 %}ðŸ˜°{% else %}ðŸ˜Š{% endif %}
          </div>
        </div>
      </div>

      <div class="mb-5 py-3 position-relative">
        <h2 id="word-display" class="text-primary fw-bold mb-0 font-monospace display-5"
          style="word-break: break-word; letter-spacing: 0.2em;">
          {{ displayed_name }}
        </h2>
        <div class="position-absolute bottom-0 start-50 translate-middle-x w-50"
          style="height: 2px; background: radial-gradient(circle, #0d6efd 0%, transparent 100%); opacity: 0.2;">
        </div>
      </div>

      <div id="input-area">
          {% if not game_over %}
          <p class="text-muted small mb-3 fw-medium">Selecciona una letra:</p>
          <div class="d-flex flex-wrap justify-content-center gap-2" id="keyboard">
            {% for letter in alphabet %}
              <button type="button" 
                id="btn-{{ letter }}"
                onclick="submitLetter('{{ letter }}')"
                class="btn btn-outline-primary btn-sm fw-bold shadow-sm hover-scale {% if letter in used_letters %}disabled-letter{% endif %}"
                style="width: 42px; height: 42px; border-radius: 12px;"
                {% if letter in used_letters %}disabled{% endif %}>
                {{ letter }}
              </button>
            {% endfor %}
          </div>

          <div class="alert bg-blue-50 border-0 small text-blue-700 rounded-3 mt-4 d-flex align-items-center gap-2">
            <i class="fas fa-lightbulb text-warning"></i>
            <span><strong>Pista:</strong> Las tildes y espacios se gestionan automÃ¡ticamente.</span>
          </div>
          {% else %}
          <div class="animate-scale-in">
             <h4 class="fw-bold {% if won %}text-success{% else %}text-danger{% endif %}">
                {{ won|yesno:"Â¡Ganaste!,Â¡Perdiste!" }}
             </h4>
             <p>El nombre era: <strong>{{ target_name }}</strong></p>
             <a href="{% url 'hangman_game' group.id %}" class="btn btn-primary rounded-pill px-5 shadow-sm">
                <i class="fas fa-arrow-right me-2"></i>Siguiente Alumno
             </a>
          </div>
          {% endif %}
      </div>

    </div>
  </div>

  <div class="text-center mt-4 mb-5 animate-fade-in delay-300">
    <a href="{% url 'group_detail' group.id %}" class="btn btn-link text-muted text-decoration-none">
      <i class="fas fa-arrow-left me-2"></i> Volver a la clase
    </a>
  </div>
</div>

<style>
  .disabled-letter { opacity: 0.3; transform: scale(0.9) !important; pointer-events: none; }
  .bg-blue-50 { background-color: #eff6ff; }
  .text-blue-700 { color: #1d4ed8; }
  .hover-scale { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
  .hover-scale:hover { transform: scale(1.15); z-index: 10; background-color: #0d6efd; color: white; }
  .keyframe-bounce { animation: bounce 1s infinite; }
  .shadow-glow { box-shadow: 0 0 20px rgba(13, 110, 253, 0.1); }
  @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
</style>

<script>
function submitLetter(letter) {
    const formData = new FormData();
    formData.append('action', 'guess_letter');
    formData.append('letter', letter);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    const btn = document.getElementById('btn-' + letter);
    if(btn) {
        btn.disabled = true;
        btn.classList.add('disabled-letter');
    }

    fetch("{% url 'hangman_game' group.id %}", {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        // Actualizar visualizaciÃ³n de la palabra
        document.getElementById('word-display').innerText = data.displayed_name;
        
        // Actualizar intentos y progreso
        document.getElementById('attempts-text').innerText = `${data.incorrect_count}/${data.max_incorrect}`;
        const progress = (data.incorrect_count / data.max_incorrect) * 100;
        const progressBar = document.getElementById('hangman-progress-bar');
        progressBar.style.width = progress + '%';
        
        if(progress > 70) {
            progressBar.classList.remove('bg-success');
            progressBar.classList.add('bg-danger');
        }

        // Actualizar emoji
        const emojiDiv = document.getElementById('status-emoji');
        if (data.incorrect_count >= data.max_incorrect) emojiDiv.innerText = 'ðŸ˜µ';
        else if (data.incorrect_count >= 1) emojiDiv.innerText = 'ðŸ˜°';
        else emojiDiv.innerText = 'ðŸ˜Š';

        // Manejar fin del juego
        if (data.game_over) {
            setTimeout(() => {
                Swal.fire({
                    title: data.won ? 'Â¡Lo lograste!' : 'Â¡Agotado!',
                    text: data.won ? 'Has descubierto el nombre correctamente.' : `El nombre era: ${data.target_name}`,
                    icon: data.won ? 'success' : 'error',
                    confirmButtonText: 'Siguiente Alumno',
                    confirmButtonColor: '#0d6efd',
                    allowOutsideClick: false
                }).then(() => {
                    window.location.href = "{% url 'hangman_game' group.id %}";
                });
            }, 300);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if(btn) btn.disabled = false;
    });
}
</script>
{% endblock %}