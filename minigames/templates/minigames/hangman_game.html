{% extends "base.html" %}
{% load static %}
{% block title %}Ahorcado | RELACIONA{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container mt-4" style="max-width: 600px;">
  <div class="text-center mb-4 animate-slide-up">
    <div class="d-inline-flex align-items-center px-4 py-2 bg-white rounded-pill shadow-sm border">
      <span class="text-muted small fw-bold text-uppercase me-2">Puntuaci贸n</span>
      <span class="fw-bold fs-5 text-primary">
        <i class="fas fa-star text-warning me-1"></i>
        <span id="score-correct">{{ correct }}</span> / <span id="score-total">{{ total }}</span>
      </span>
    </div>
  </div>

  <div class="card card-glass shadow-lg border-0 animate-slide-up">
    <div class="card-body p-4 text-center">
      <h3 class="mb-4 fw-bold text-primary">Ahorcado</h3>

      <div class="mb-4 position-relative d-inline-block">
        <div class="rounded-circle shadow-glow p-1 bg-white border">
          {% if current_student.profile_picture %}
          <img src="{{ current_student.profile_picture.url }}" class="rounded-circle object-fit-cover"
            style="width: 140px; height: 140px; border: 4px solid #0d6efd;" alt="Alumno">
          {% else %}
          <div class="bg-light rounded-circle d-flex align-items-center justify-content-center mx-auto"
            style="width: 140px; height: 140px;">
            <i class="fas fa-user fa-4x text-muted opacity-25"></i>
          </div>
          {% endif %}
        </div>
      </div>

      <div class="mb-4">
        <div class="d-flex justify-content-between mb-1">
          <span class="text-muted small fw-bold">INTENTOS INCORRECTOS</span>
          <span id="attempts-text" class="fw-bold">{{ incorrect_count }}/{{ max_incorrect }}</span>
        </div>
        <div class="progress" style="height: 10px; border-radius: 5px;">
          <div id="hangman-progress-bar"
            class="progress-bar {% if incorrect_count > 4 %}bg-danger{% else %}bg-success{% endif %}" role="progressbar"
            style="width: {% widthratio incorrect_count max_incorrect 100 %}%"></div>
        </div>
      </div>

      <div class="mb-5">
        <h2 id="word-display" class="text-primary fw-bold font-monospace display-6" style="letter-spacing: 0.15em;">
          {{ displayed_name }}
        </h2>
      </div>

      <div id="input-area">
        <div class="d-flex flex-wrap justify-content-center gap-2" id="keyboard">
          {% for letter in alphabet %}
          <button type="button" id="btn-{{ letter }}" onclick="submitLetter('{{ letter }}')"
            class="btn btn-outline-primary fw-bold shadow-sm {% if letter in used_letters %}disabled-letter{% endif %}"
            style="width: 42px; height: 42px;" {% if letter in used_letters or game_over %}disabled{% endif %}>
            {{ letter }}
          </button>
          {% endfor %}
        </div>
      </div>

    </div>
  </div>

  <div class="text-center mt-4 mb-5 d-flex justify-content-center gap-3">
    <a href="{% url 'hangman_game' group.id %}" class="btn btn-light text-muted fw-medium">
      <i class="fas fa-redo me-1"></i> Reiniciar/Saltar
    </a>
    <a href="{% url 'student_home' %}" class="btn btn-light text-muted fw-medium">
      <i class="fas fa-arrow-left me-1"></i> Volver al panel
    </a>
  </div>
</div>

<style>
  .disabled-letter {
    opacity: 0.3 !important;
    pointer-events: none;
    background-color: #f8f9fa !important;
    color: #dee2e6 !important;
  }

  .font-monospace {
    letter-spacing: 0.3em !important;
  }

  .shadow-glow {
    box-shadow: 0 0 20px rgba(13, 110, 253, 0.15);
  }

  .card-glass {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
  }
</style>

<script>
  function submitLetter(letter) {
    const formData = new FormData();
    formData.append('action', 'guess_letter');
    formData.append('letter', letter);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    const btn = document.getElementById('btn-' + letter);
    if (btn) {
      btn.disabled = true;
      btn.classList.add('disabled-letter');
    }

    fetch("{% url 'hangman_game' group.id %}", {
      method: 'POST',
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then(response => response.json())
      .then(data => {
        // 1. Actualizar palabra e intentos
        document.getElementById('word-display').innerText = data.displayed_name;
        document.getElementById('attempts-text').innerText = `${data.incorrect_count}/${data.max_incorrect}`;

        // 2. Actualizar barra de progreso
        const progress = (data.incorrect_count / data.max_incorrect) * 100;
        const progressBar = document.getElementById('hangman-progress-bar');
        progressBar.style.width = progress + '%';

        if (data.incorrect_count >= 5) {
          progressBar.classList.remove('bg-success');
          progressBar.classList.add('bg-danger');
        }

        // 3. Si el juego termin贸
        if (data.game_over) {
          // Actualizar marcador visual de la sesi贸n
          document.getElementById('score-correct').innerText = data.correct;
          document.getElementById('score-total').innerText = data.total;

          // Bloquear todos los botones del teclado
          document.querySelectorAll('#keyboard button').forEach(b => b.disabled = true);

          setTimeout(() => {
            Swal.fire({
              title: data.won ? '隆Lo lograste! ' : '隆Oh no! ',
              text: data.won ? 'Has adivinado el nombre correctamente.' : `El nombre era: ${data.target_name}`,
              icon: data.won ? 'success' : 'error',
              confirmButtonText: 'Siguiente Alumno',
              confirmButtonColor: '#0d6efd',
              allowOutsideClick: false
            }).then(() => {
              // Recargar para limpiar la sesi贸n del juego y elegir nuevo alumno
              window.location.reload();
            });
          }, 400);
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
  }
</script>
{% endblock %}