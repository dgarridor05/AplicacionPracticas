{% extends "base.html" %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;800&display=swap" rel="stylesheet">

<div id="game-container" class="container py-4" style="font-family: 'Outfit', sans-serif; max-width: 500px;">
    
    <div class="text-center mb-4">
        <div class="mb-2">
            <i class="fas fa-user-secret fa-3x" style="color: #ff4b2b;"></i>
        </div>
        <h5 class="fw-bold color-impostor-red mb-3">MÃ¡ster Profesorado UEx</h5>
        <div class="badge bg-custom-dark px-3 py-2 rounded-pill shadow-sm">
            <i class="fas fa-bullseye me-2 text-warning"></i>TEMA: {{ tema }}
        </div>
    </div>

    <div id="step-1" class="animate-fade-in">
        <div class="card border-0 shadow-lg rounded-5 p-4 mb-4 bg-white text-center border-top border-4 border-danger">
            <h3 class="fw-800 mb-4 color-impostor-dark">ConfiguraciÃ³n</h3>
            
            <div class="mb-4">
                <label class="form-label fw-bold text-muted small text-uppercase mb-3">Â¿CuÃ¡ntos sois?</label>
                <div class="d-flex align-items-center justify-content-center gap-4">
                    <button type="button" class="btn btn-impostor-outline rounded-circle" onclick="adjust('total', -1)">-</button>
                    <span id="label-total" class="display-5 fw-800 color-impostor-dark">4</span>
                    <button type="button" class="btn btn-impostor-outline rounded-circle" onclick="adjust('total', 1)">+</button>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="form-label fw-bold text-muted small text-uppercase mb-3">NÂº de Impostores</label>
                <div class="d-flex align-items-center justify-content-center gap-4">
                    <button type="button" class="btn btn-impostor-outline-orange rounded-circle" onclick="adjust('imp', -1)">-</button>
                    <span id="label-imp" class="display-5 fw-800 text-orange-rel">1</span>
                    <button type="button" class="btn btn-impostor-outline-orange rounded-circle" onclick="adjust('imp', 1)">+</button>
                </div>
            </div>

            <div class="alert alert-danger rounded-4 mb-0 py-2 border-0 bg-opacity-10 bg-danger">
                <small class="fw-bold text-danger"><i class="fas fa-comment-slash me-1"></i> REGLA: Solo una palabra tÃ©cnica por turno.</small>
            </div>
        </div>
        <button class="btn btn-impostor-gradient w-100 rounded-pill py-3 fw-bold shadow-lg" onclick="prepararRoles()">
            INICIAR MISIÃ“N <i class="fas fa-rocket ms-2"></i>
        </button>
    </div>

    <div id="step-2" class="d-none animate-fade-in text-center">
        <h2 id="display-jugador" class="fw-800 color-impostor-dark mb-0">JUGADOR 1</h2>
        <p class="text-muted mb-4">Pasa el dispositivo y mantÃ©n pulsado</p>

        <div id="btn-reveal" class="card-reveal shadow-lg rounded-5 mb-4 d-flex align-items-center justify-content-center">
            <div id="tap-msg">
                <div class="pulse-icon mb-3">
                    <i class="fas fa-id-badge fa-4x text-white"></i>
                </div>
                <h4 class="fw-bold text-white">MANTÃ‰N PARA VER</h4>
            </div>

            <div id="secret-msg" class="d-none px-3">
                <span class="badge bg-white text-dark mb-2 px-3 py-2 rounded-pill fw-bold" id="role-tag"></span>
                <h1 class="display-4 fw-800 text-white" id="word-tag">---</h1>
            </div>
        </div>

        <button id="btn-next" class="btn btn-dark btn-lg w-100 rounded-pill py-3 d-none fw-bold shadow" onclick="siguienteTurno()">
            CONFIRMADO <i class="fas fa-check-circle ms-2"></i>
        </button>
    </div>

    <div id="step-3" class="d-none animate-fade-in text-center py-4">
        <div class="debate-circle mb-4 shadow-lg">
            <i class="fas fa-exclamation-triangle fa-3x text-white"></i>
        </div>
        <h2 class="fw-800 color-impostor-red">Â¡EMERGENCIA!</h2>
        <p class="text-muted mb-5 px-3">Hay un <b>impostor</b> entre nosotros. Debatid con una sola palabra.</p>
        
        <button id="btn-ver-impostor" class="btn btn-outline-dark w-100 rounded-pill py-3 mb-3 fw-bold border-2" onclick="revelarImpostor()">
            REVELAR IMPOSTOR
        </button>

        <a href="" class="btn btn-impostor-gradient w-100 rounded-pill py-3 fw-bold shadow-lg">
            NUEVA PARTIDA <i class="fas fa-redo ms-2"></i>
        </a>
    </div>
</div>

<style>
    :root {
        --imp-red: #ff4b2b;
        --imp-orange: #ff416c;
        --imp-dark: #2c3e50;
        --imp-bg-dark: #1a1a1a;
    }
    .fw-800 { font-weight: 800; }
    .color-impostor-red { color: var(--imp-red); }
    .color-impostor-dark { color: var(--imp-dark); }
    .text-orange-rel { color: #f39c12; }
    .bg-custom-dark { background-color: var(--imp-dark); }

    .btn-impostor-outline { border: 3px solid var(--imp-dark); color: var(--imp-dark); font-weight: bold; width: 55px; height: 55px; }
    .btn-impostor-outline-orange { border: 3px solid #f39c12; color: #f39c12; font-weight: bold; width: 55px; height: 55px; }
    
    .btn-impostor-gradient { 
        background: linear-gradient(135deg, #ff4b2b, #ff416c); 
        border: none; 
        color: white; 
        transition: all 0.3s;
    }
    .btn-impostor-gradient:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(255, 75, 43, 0.3); color: white; }

    .card-reveal {
        min-height: 320px;
        background: linear-gradient(135deg, var(--imp-dark), #1c2833);
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .pulse-icon { animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

    .debate-circle { 
        width: 100px; height: 100px; 
        background: var(--imp-red); 
        border-radius: 50%; 
        display: flex; align-items: center; justify-content: center; 
        margin: 0 auto;
        border: 5px solid white;
    }

    .animate-fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<script>
let totalPlayers = 4, totalImpostors = 1, currentIndex = 0;
let roles = [];
const palabraC = "{{ palabra_correcta }}", pistaI = "{{ pista_impostor }}";

function adjust(type, val) {
    if(type === 'total') { totalPlayers = Math.max(3, totalPlayers + val); }
    else { totalImpostors = Math.max(1, Math.min(totalPlayers - 1, totalImpostors + val)); }
    document.getElementById('label-total').innerText = totalPlayers;
    document.getElementById('label-imp').innerText = totalImpostors;
}

function prepararRoles() {
    roles = new Array(totalPlayers).fill('civil');
    for(let i=0; i<totalImpostors; i++) roles[i] = 'impostor';
    roles.sort(() => Math.random() - 0.5);
    document.getElementById('step-1').classList.add('d-none');
    document.getElementById('step-2').classList.remove('d-none');
    actualizarInterfaz();
}

function actualizarInterfaz() {
    document.getElementById('display-jugador').innerText = `JUGADOR ${currentIndex + 1}`;
    document.getElementById('role-tag').innerText = roles[currentIndex] === 'impostor' ? 'ðŸš¨ ERES EL IMPOSTOR' : 'ðŸ›¡ï¸ ERES CIVIL';
    document.getElementById('word-tag').innerText = roles[currentIndex] === 'impostor' ? pistaI : palabraC;
    document.getElementById('btn-next').classList.add('d-none');
}

const revealCard = document.getElementById('btn-reveal');
const show = (e) => { 
    if(e) e.preventDefault();
    document.getElementById('tap-msg').classList.add('d-none'); 
    document.getElementById('secret-msg').classList.remove('d-none');
    document.getElementById('btn-next').classList.remove('d-none');
    // Si es impostor rojo fuego, si es civil un azul oscuro/negro
    revealCard.style.background = roles[currentIndex] === 'impostor' ? 'linear-gradient(135deg, #d63031, #eb4d4b)' : 'linear-gradient(135deg, #2c3e50, #000000)';
};
const hide = () => { 
    document.getElementById('tap-msg').classList.remove('d-none'); 
    document.getElementById('secret-msg').classList.add('d-none');
    revealCard.style.background = 'linear-gradient(135deg, #2c3e50, #1c2833)';
};

revealCard.addEventListener('mousedown', show);
revealCard.addEventListener('mouseup', hide);
revealCard.addEventListener('touchstart', show);
revealCard.addEventListener('touchend', hide);

function siguienteTurno() {
    currentIndex++;
    if(currentIndex < totalPlayers) {
        actualizarInterfaz();
        hide();
    } else {
        document.getElementById('step-2').classList.add('d-none');
        document.getElementById('step-3').classList.remove('d-none');
    }
}

function revelarImpostor() {
    let imps = roles.map((r, i) => r === 'impostor' ? (i + 1) : null).filter(n => n);
    alert("ðŸ“¢ ARCHIVO DESCLASIFICADO\n\nImpostor detectado: JUGADOR " + imps.join(", ") + "\n\nLa palabra de los civiles era: " + palabraC.toUpperCase());
    document.getElementById('btn-ver-impostor').classList.add('disabled');
}
</script>
{% endblock %}