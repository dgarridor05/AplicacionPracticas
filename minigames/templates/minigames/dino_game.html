{% extends "base.html" %}
{% block title %}Student Runner Pro{% endblock %}

{% block content %}
<div class="container-fluid py-2 py-md-4 text-center game-main-container">
    <div class="d-flex justify-content-between align-items-center mb-3 mb-md-4 px-2" style="max-width: 800px; margin: 0 auto; width: 100%;">
        <a href="{% url 'student_home' %}" class="btn btn-sm btn-outline-secondary border-0 shadow-sm">
            <i class="fas fa-chevron-left"></i> <span class="d-none d-sm-inline">Salir</span>
        </a>
        <div class="game-stats d-flex gap-3 gap-md-4">
            <div class="stat-item"><small>HI-SCORE</small> <span id="highScore">00000</span></div>
            <div class="stat-item text-primary"><small>SCORE</small> <span id="currentScore">00000</span></div>
        </div>
    </div>

    <div class="game-wrapper shadow-lg" id="gameWrapper">
        <canvas id="gameCanvas" width="800" height="400"></canvas>
        
        <div id="overlay" class="game-overlay">
            <div id="start-screen" class="px-3">
                <div class="avatar-preview mb-2 mb-md-3">
                    {% if user.profile_picture %}
                        <img src="{{ user.profile_picture.url }}" id="playerImg" crossorigin="anonymous">
                    {% else %}
                        <img src="https://ui-avatars.com/api/?background=4834d4&color=fff&name={{ user.first_name }}" id="playerImg" crossorigin="anonymous">
                    {% endif %}
                </div>
                <h2 class="fw-bold mb-1 fs-4 fs-md-2">STUDENT RUN</h2>
                <p class="text-muted small mb-3">TOCA O PULSA [ESPACIO] PARA SALTAR</p>
                <button id="startBtn" class="btn btn-dark rounded-pill px-4 shadow-sm">JUGAR</button>
            </div>
            
            <div id="game-over-screen" style="display: none;" class="px-3">
                <h1 class="text-danger fw-black mb-0 fs-3 fs-md-1">춰SUSPENSO!</h1>
                <p id="finalScoreText" class="mb-3 text-muted small"></p>
                <button id="restartBtn" class="btn btn-primary rounded-pill px-5 shadow">
                    REINTENTAR <i class="fas fa-redo ms-2"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    :root { --game-bg: #ffffff; }
    
    /* Evitamos el scroll el치stico en m칩viles para que no se mueva la pantalla al jugar */
    body { overflow: hidden; position: fixed; width: 100%; }

    .game-main-container {
        height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .game-wrapper {
        position: relative;
        width: 100%;
        max-width: 800px;
        /* En m칩vil ocupar치 m치s espacio vertical proporcionalmente */
        aspect-ratio: 8 / 10; 
        margin: 0 auto;
        background: var(--game-bg);
        border-radius: 20px;
        overflow: hidden;
        border: 4px solid #f0f0f0;
        touch-action: none; 
        -webkit-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }

    /* En pantallas grandes volvemos a un formato m치s horizontal */
    @media (min-width: 768px) {
        .game-wrapper { aspect-ratio: 2 / 1; }
    }

    #gameCanvas {
        width: 100% !important;
        height: 100% !important;
        display: block;
        object-fit: cover; /* Clave para que el dibujo interno no se deforme */
    }

    .game-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; align-items: center; justify-content: center;
        background: rgba(255,255,255,0.85); transition: 0.3s;
        z-index: 10;
    }

    .avatar-preview img {
        width: 60px; height: 60px; border-radius: 50%;
        border: 3px solid #4834d4; object-fit: cover;
    }
    
    @media (min-width: 768px) {
        .avatar-preview img { width: 80px; height: 80px; border-width: 4px; }
    }

    .stat-item { font-family: 'Courier New', Courier, monospace; font-weight: bold; font-size: 1rem; }
    @media (min-width: 768px) { .stat-item { font-size: 1.2rem; } }
    .stat-item small { font-size: 0.6rem; color: #636e72; display: block; line-height: 1; }
</style>

<script>
class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.img = document.getElementById('playerImg');
        this.wrapper = document.getElementById('gameWrapper');
        
        // Resoluci칩n l칩gica: 800x400 da m치s aire vertical
        this.canvas.width = 800;
        this.canvas.height = 400;
        
        this.baseSpeed = 7;
        this.speed = this.baseSpeed;
        this.gravity = 0.85;
        this.jumpForce = 17;
        this.jumpCutoff = 0.35;
        
        this.player = {
            x: 80, y: 0, w: 58, h: 58,
            dy: 0, grounded: false, isJumping: false
        };

        this.obstacles = [];
        this.score = 0;
        this.highScore = 0;
        this.active = false;
        
        this.init();
    }

    init() {
        const handleStartJump = (e) => {
            if (!this.active) return;
            if (this.player.grounded) {
                this.player.dy = -this.jumpForce;
                this.player.grounded = false;
                this.player.isJumping = true;
            }
        };

        const handleEndJump = () => {
            if (this.player.isJumping && this.player.dy < -3) {
                this.player.dy *= this.jumpCutoff;
                this.player.isJumping = false;
            }
        };

        // Eventos t치ctiles mejorados para m칩vil
        this.wrapper.addEventListener('touchstart', (e) => {
            if (this.active) { e.preventDefault(); handleStartJump(e); }
        }, { passive: false });

        this.wrapper.addEventListener('touchend', (e) => {
            if (this.active) { e.preventDefault(); handleEndJump(); }
        }, { passive: false });

        // Eventos de rat칩n y teclado
        this.wrapper.addEventListener('mousedown', (e) => handleStartJump(e));
        window.addEventListener('mouseup', handleEndJump);
        window.addEventListener('keydown', (e) => { 
            if(e.code === 'Space') { e.preventDefault(); handleStartJump(e); }
        });

        document.getElementById('startBtn').onclick = (e) => { e.stopPropagation(); this.start(); };
        document.getElementById('restartBtn').onclick = (e) => { e.stopPropagation(); this.start(); };
    }

    start() {
        this.active = true;
        this.score = 0;
        this.speed = this.baseSpeed;
        this.obstacles = [];
        // Posicionamos al jugador bas치ndonos en el nuevo nivel del suelo
        this.player.y = this.canvas.height - 150;
        this.player.dy = 0;
        
        document.getElementById('overlay').style.background = 'transparent';
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-over-screen').style.display = 'none';
        this.loop();
    }

    update() {
        this.score += 0.15;
        this.speed = this.baseSpeed + (this.score / 65); 
        document.getElementById('currentScore').innerText = Math.floor(this.score).toString().padStart(5, '0');

        this.player.dy += this.gravity;
        this.player.y += this.player.dy;

        // NIVEL DEL SUELO ELEVADO: 100px desde el fondo para evitar que el dedo tape
        const groundLevel = this.canvas.height - 100;
        if (this.player.y > groundLevel - this.player.h) {
            this.player.y = groundLevel - this.player.h;
            this.player.dy = 0;
            this.player.grounded = true;
            this.player.isJumping = false;
        }

        const minGap = 280 + (this.speed * 5);
        if (this.obstacles.length === 0 || (this.canvas.width - this.obstacles[this.obstacles.length-1].x) > minGap) {
            if (Math.random() < 0.04) {
                const icons = ['游닄', '游닇', '游', '游늻', '游'];
                this.obstacles.push({
                    x: this.canvas.width,
                    y: groundLevel - 42,
                    w: 42, h: 42,
                    icon: icons[Math.floor(Math.random() * icons.length)]
                });
            }
        }

        this.obstacles.forEach((obs, i) => {
            obs.x -= this.speed;
            // Colisi칩n por proximidad
            const pX = this.player.x + this.player.w/2;
            const pY = this.player.y + this.player.h/2;
            const oX = obs.x + obs.w/2;
            const oY = obs.y + obs.h/2;
            if (Math.sqrt((pX - oX)**2 + (pY - oY)**2) < 40) this.gameOver();
            if (obs.x + obs.w < -50) this.obstacles.splice(i, 1);
        });
    }

    draw() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        // Suelo estilizado
        const groundLevel = this.canvas.height - 100;
        this.ctx.strokeStyle = '#dfe6e9';
        this.ctx.lineWidth = 3;
        this.ctx.beginPath();
        this.ctx.moveTo(0, groundLevel);
        this.ctx.lineTo(this.canvas.width, groundLevel);
        this.ctx.stroke();

        // Jugador (C칤rculo con imagen)
        this.ctx.save();
        this.ctx.beginPath();
        this.ctx.arc(this.player.x + this.player.w/2, this.player.y + this.player.h/2, this.player.w/2, 0, Math.PI*2);
        this.ctx.clip();
        if (this.img && this.img.complete) {
            this.ctx.drawImage(this.img, this.player.x, this.player.y, this.player.w, this.player.h);
        } else {
            this.ctx.fillStyle = '#4834d4'; this.ctx.fill();
        }
        this.ctx.restore();
        
        // Borde del jugador
        this.ctx.strokeStyle = this.player.grounded ? '#4834d4' : '#686de0';
        this.ctx.lineWidth = 3;
        this.ctx.stroke();

        // Obst치culos
        this.ctx.font = '38px Arial';
        this.obstacles.forEach(obs => {
            this.ctx.fillText(obs.icon, obs.x, obs.y + 35);
        });
    }

    gameOver() {
        this.active = false;
        if (this.score > this.highScore) this.highScore = this.score;
        document.getElementById('highScore').innerText = Math.floor(this.highScore).toString().padStart(5, '0');
        document.getElementById('finalScoreText').innerText = `HAS CONSEGUIDO ${Math.floor(this.score)} PUNTOS`;
        document.getElementById('overlay').style.background = 'rgba(255,255,255,0.92)';
        document.getElementById('game-over-screen').style.display = 'block';
    }

    loop() {
        if (!this.active) return;
        this.update();
        this.draw();
        requestAnimationFrame(() => this.loop());
    }
}

const game = new Game();
</script>
{% endblock %}