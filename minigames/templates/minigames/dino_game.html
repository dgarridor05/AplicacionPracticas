{% extends "base.html" %}
{% block title %}Student Runner Pro{% endblock %}

{% block content %}
<div class="container-fluid py-2 py-md-3 text-center game-main-container">
    <div class="d-flex justify-content-between align-items-center mb-2 px-2 mx-auto" style="max-width: 600px; width: 100%;">
        <a href="{% url 'student_home' %}" class="btn btn-sm btn-outline-secondary border-0">
            <i class="fas fa-chevron-left"></i>
        </a>
        <div class="game-stats d-flex gap-3">
            <div class="stat-item"><small>HI</small> <span id="highScore">00000</span></div>
            <div class="stat-item text-primary"><small>SCORE</small> <span id="currentScore">00000</span></div>
        </div>
    </div>

    <div class="game-wrapper shadow-lg" id="gameWrapper">
        <canvas id="gameCanvas"></canvas>
        
        <div id="overlay" class="game-overlay">
            <div id="start-screen" class="px-3">
                <div class="avatar-preview mb-3">
                    {% if user.profile_picture %}
                        <img src="{{ user.profile_picture.url }}" id="playerImg" crossorigin="anonymous">
                    {% else %}
                        <img src="https://ui-avatars.com/api/?background=4834d4&color=fff&name={{ user.first_name }}" id="playerImg" crossorigin="anonymous">
                    {% endif %}
                </div>
                <h2 class="fw-bold mb-1 fs-4">STUDENT RUN</h2>
                <p class="text-muted small mb-3">TOCA PARA SALTAR</p>
                <button id="startBtn" class="btn btn-dark rounded-pill px-4">JUGAR</button>
            </div>
            
            <div id="game-over-screen" style="display: none;" class="px-3">
                <h1 class="text-danger fw-bold mb-0 fs-3">춰SUSPENSO!</h1>
                <p id="finalScoreText" class="mb-3 text-muted small"></p>
                <button id="restartBtn" class="btn btn-primary rounded-pill px-5 shadow">
                    REINTENTAR <i class="fas fa-redo ms-2"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    :root { --game-bg: #f8f9fa; }
    
    body { 
        overflow: hidden; 
        position: fixed; 
        width: 100%; 
        background-color: #f0f2f5;
    }

    .game-main-container {
        height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
    }

    .game-wrapper {
        position: relative;
        width: 95%;
        max-width: 500px; /* Ancho m치s controlado para m칩viles */
        aspect-ratio: 9 / 13; /* Proporci칩n ideal para ver todo y tener zona de toque */
        margin: 0 auto;
        background: var(--game-bg);
        border-radius: 24px;
        overflow: hidden;
        border: 6px solid white;
        touch-action: none; 
        -webkit-user-select: none;
        user-select: none;
    }

    #gameCanvas {
        width: 100% !important;
        height: 100% !important;
        display: block;
        background: linear-gradient(to bottom, #a1c4fd 0%, #c2e9fb 100%); /* Cielo inicial */
    }

    .game-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; align-items: center; justify-content: center;
        background: rgba(255,255,255,0.8); transition: 0.3s;
        z-index: 10;
    }

    .avatar-preview img {
        width: 70px; height: 70px; border-radius: 50%;
        border: 4px solid #4834d4; object-fit: cover;
    }

    .stat-item { font-family: 'monospace'; font-weight: bold; font-size: 1rem; }
    .stat-item small { font-size: 0.6rem; color: #636e72; display: block; }
</style>

<script>
class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.img = document.getElementById('playerImg');
        this.wrapper = document.getElementById('gameWrapper');
        
        // Resoluci칩n interna fija para consistencia
        this.canvas.width = 450;
        this.canvas.height = 650;
        
        this.baseSpeed = 6;
        this.speed = this.baseSpeed;
        this.gravity = 0.8;
        this.jumpForce = 15;
        
        // El suelo est치 m치s arriba (30% del canvas desde abajo libre para el dedo)
        this.groundY = this.canvas.height - 180;

        this.player = {
            x: 50, y: 0, w: 50, h: 50,
            dy: 0, grounded: false
        };

        // Para el fondo infinito (Pasillo)
        this.bgX = 0;
        this.bgSpeed = 2;

        this.obstacles = [];
        this.score = 0;
        this.highScore = 0;
        this.active = false;
        
        this.init();
    }

    init() {
        const jump = (e) => {
            if (!this.active) return;
            if (this.player.grounded) {
                this.player.dy = -this.jumpForce;
                this.player.grounded = false;
            }
            if(e) e.preventDefault();
        };

        this.wrapper.addEventListener('touchstart', jump, { passive: false });
        this.wrapper.addEventListener('mousedown', jump);
        window.addEventListener('keydown', (e) => { if(e.code === 'Space') jump(); });

        document.getElementById('startBtn').onclick = () => this.start();
        document.getElementById('restartBtn').onclick = () => this.start();
    }

    start() {
        this.active = true;
        this.score = 0;
        this.speed = this.baseSpeed;
        this.obstacles = [];
        this.player.y = this.groundY - this.player.h;
        this.player.dy = 0;
        
        document.getElementById('overlay').style.opacity = '0';
        setTimeout(() => {
            if(this.active) document.getElementById('overlay').style.visibility = 'hidden';
        }, 300);
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-over-screen').style.display = 'none';
        this.loop();
    }

    drawBackground() {
        // Dibujamos "ventanas" o "puertas" que se mueven
        this.bgX -= this.speed * 0.5; // Se mueve m치s lento que los obst치culos
        if (this.bgX <= -200) this.bgX = 0;

        this.ctx.fillStyle = '#e1e8ed'; // Pared del pasillo
        this.ctx.fillRect(0, 0, this.canvas.width, this.groundY);

        for (let i = 0; i < 5; i++) {
            // Ventanas
            this.ctx.fillStyle = '#ffffff';
            this.ctx.fillRect(this.bgX + (i * 200), 100, 80, 120);
            // Detalles de la ventana
            this.ctx.strokeStyle = '#b2bec3';
            this.ctx.strokeRect(this.bgX + (i * 200), 100, 80, 120);
        }

        // Suelo (Pasillo)
        this.ctx.fillStyle = '#dfe6e9';
        this.ctx.fillRect(0, this.groundY, this.canvas.width, this.canvas.height - this.groundY);
        this.ctx.fillStyle = '#b2bec3';
        this.ctx.fillRect(0, this.groundY, this.canvas.width, 4);
    }

    update() {
        this.score += 0.1;
        this.speed = this.baseSpeed + (this.score / 50); 
        document.getElementById('currentScore').innerText = Math.floor(this.score).toString().padStart(5, '0');

        this.player.dy += this.gravity;
        this.player.y += this.player.dy;

        if (this.player.y > this.groundY - this.player.h) {
            this.player.y = this.groundY - this.player.h;
            this.player.dy = 0;
            this.player.grounded = true;
        }

        // Generar obst치culos
        if (this.obstacles.length === 0 || (this.canvas.width - this.obstacles[this.obstacles.length-1].x) > 300) {
            if (Math.random() < 0.05) {
                this.obstacles.push({
                    x: this.canvas.width,
                    y: this.groundY - 45,
                    w: 40, h: 40,
                    icon: ['游닄', '游', '游빍', '游늻'][Math.floor(Math.random()*4)]
                });
            }
        }

        this.obstacles.forEach((obs, i) => {
            obs.x -= this.speed;
            
            // Colisi칩n ajustada
            if (this.player.x < obs.x + obs.w - 10 &&
                this.player.x + this.player.w - 10 > obs.x &&
                this.player.y < obs.y + obs.h - 10 &&
                this.player.y + this.player.h - 10 > obs.y) {
                this.gameOver();
            }
            
            if (obs.x < -50) this.obstacles.splice(i, 1);
        });
    }

    draw() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        this.drawBackground();

        // Jugador
        this.ctx.save();
        this.ctx.beginPath();
        this.ctx.arc(this.player.x + 25, this.player.y + 25, 25, 0, Math.PI*2);
        this.ctx.clip();
        if (this.img && this.img.complete) {
            this.ctx.drawImage(this.img, this.player.x, this.player.y, 50, 50);
        }
        this.ctx.restore();
        this.ctx.strokeStyle = '#4834d4';
        this.ctx.lineWidth = 3;
        this.ctx.stroke();

        // Obst치culos
        this.ctx.font = '30px Arial';
        this.obstacles.forEach(obs => {
            this.ctx.fillText(obs.icon, obs.x, obs.y + 32);
        });
    }

    gameOver() {
        this.active = false;
        if (this.score > this.highScore) this.highScore = this.score;
        document.getElementById('highScore').innerText = Math.floor(this.highScore).toString().padStart(5, '0');
        document.getElementById('finalScoreText').innerText = `PUNTUACI칍N: ${Math.floor(this.score)}`;
        
        const overlay = document.getElementById('overlay');
        overlay.style.visibility = 'visible';
        overlay.style.opacity = '1';
        document.getElementById('game-over-screen').style.display = 'block';
    }

    loop() {
        if (!this.active) return;
        this.update();
        this.draw();
        requestAnimationFrame(() => this.loop());
    }
}

const game = new Game();
</script>
{% endblock %}