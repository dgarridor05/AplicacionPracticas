{% extends "base.html" %}
{% block title %}Student Runner Pro{% endblock %}

{% block content %}
<div class="container-fluid py-2 py-md-3 text-center game-main-container">
    <div class="d-flex justify-content-between align-items-center mb-2 px-2 mx-auto header-controls">
        <a href="{% url 'student_home' %}" class="btn btn-sm btn-outline-secondary border-0">
            <i class="fas fa-chevron-left"></i> <span class="d-none d-md-inline">Salir</span>
        </a>
        <div class="game-stats d-flex gap-3">
            <div class="stat-item"><small>HI-SCORE</small> <span id="highScore">00000</span></div>
            <div class="stat-item text-primary"><small>SCORE</small> <span id="currentScore">00000</span></div>
        </div>
    </div>

    <div class="game-wrapper shadow-lg" id="gameWrapper">
        <canvas id="gameCanvas"></canvas>
        
        <div id="overlay" class="game-overlay">
            <div id="start-screen" class="px-3">
                <div class="avatar-preview mb-3">
                    {% if user.profile_picture %}
                        <img src="{{ user.profile_picture.url }}" id="playerImg" crossorigin="anonymous">
                    {% else %}
                        <img src="https://ui-avatars.com/api/?background=4834d4&color=fff&name={{ user.first_name }}" id="playerImg" crossorigin="anonymous">
                    {% endif %}
                </div>
                <h2 class="fw-bold mb-1 fs-4">STUDENT RUN</h2>
                <p class="text-muted small mb-3">MANT√âN PARA SALTAR M√ÅS ALTO</p>
                <button id="startBtn" class="btn btn-dark rounded-pill px-4">JUGAR</button>
            </div>
            
            <div id="game-over-screen" style="display: none;" class="px-3">
                <h1 class="text-danger fw-bold mb-0 fs-3">¬°SUSPENSO!</h1>
                <p id="finalScoreText" class="mb-3 text-muted small"></p>
                <button id="restartBtn" class="btn btn-primary rounded-pill px-5 shadow">
                    REINTENTAR <i class="fas fa-redo ms-2"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    :root { --game-bg: #f8f9fa; }
    body { overflow: hidden; position: fixed; width: 100%; background-color: #f0f2f5; font-family: sans-serif; }

    .header-controls { max-width: 800px; width: 100%; }

    .game-wrapper {
        position: relative;
        margin: 0 auto;
        background: var(--game-bg);
        border-radius: 20px;
        overflow: hidden;
        border: 5px solid white;
        touch-action: none; 
        user-select: none;
    }

    /* FORMATO M√ìVIL (Por defecto) */
    @media (max-width: 767px) {
        .game-wrapper { width: 92%; aspect-ratio: 9 / 14; max-width: 400px; }
    }

    /* FORMATO ORDENADOR */
    @media (min-width: 768px) {
        .game-wrapper { width: 100%; max-width: 850px; aspect-ratio: 2 / 1; }
    }

    #gameCanvas { width: 100% !important; height: 100% !important; display: block; }

    .game-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        display: flex; align-items: center; justify-content: center;
        background: rgba(255,255,255,0.85); z-index: 10;
    }

    .avatar-preview img { width: 70px; height: 70px; border-radius: 50%; border: 4px solid #4834d4; object-fit: cover; }
    .stat-item { font-family: monospace; font-weight: bold; }
    .stat-item small { font-size: 0.6rem; color: #636e72; display: block; }
</style>

<script>
class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.img = document.getElementById('playerImg');
        this.wrapper = document.getElementById('gameWrapper');
        
        this.isMobile = window.innerWidth < 768;
        this.setResolution();

        this.baseSpeed = 6;
        this.speed = this.baseSpeed;
        this.gravity = 0.7;
        this.jumpForce = -15;
        this.minJumpForce = -6; // Para cuando sueltas r√°pido

        this.player = { x: 60, y: 0, w: 55, h: 55, dy: 0, grounded: false, jumping: false };
        this.bgX = 0;
        this.obstacles = [];
        this.score = 0;
        this.highScore = 0;
        this.active = false;
        
        this.init();
    }

    setResolution() {
        if (this.isMobile) {
            this.canvas.width = 450;
            this.canvas.height = 700;
            this.groundY = this.canvas.height - 180; // Mucho espacio abajo
        } else {
            this.canvas.width = 900;
            this.canvas.height = 450;
            this.groundY = this.canvas.height - 80; // Espacio normal
        }
    }

    init() {
        const startJump = (e) => {
            if (!this.active) return;
            if (this.player.grounded) {
                this.player.dy = this.jumpForce;
                this.player.grounded = false;
                this.player.jumping = true;
            }
            if(e.cancelable) e.preventDefault();
        };

        const endJump = () => {
            // Si soltamos y a√∫n estamos subiendo r√°pido, cortamos el impulso
            if (this.player.jumping && this.player.dy < this.minJumpForce) {
                this.player.dy = this.minJumpForce;
                this.player.jumping = false;
            }
        };

        this.wrapper.addEventListener('touchstart', startJump, { passive: false });
        this.wrapper.addEventListener('touchend', endJump);
        this.wrapper.addEventListener('mousedown', startJump);
        window.addEventListener('mouseup', endJump);
        
        window.addEventListener('keydown', (e) => { 
            if(e.code === 'Space') { startJump(e); }
        });
        window.addEventListener('keyup', (e) => {
            if(e.code === 'Space') endJump();
        });

        document.getElementById('startBtn').onclick = () => this.start();
        document.getElementById('restartBtn').onclick = () => this.start();
    }

    start() {
        this.active = true;
        this.score = 0;
        this.speed = this.baseSpeed;
        this.obstacles = [];
        this.player.y = this.groundY - this.player.h;
        this.player.dy = 0;
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-over-screen').style.display = 'none';
        this.loop();
    }

    drawBackground() {
        this.bgX -= this.speed * 0.4;
        if (this.bgX <= -300) this.bgX = 0;

        // Pared
        this.ctx.fillStyle = '#f1f2f6';
        this.ctx.fillRect(0, 0, this.canvas.width, this.groundY);

        // Decoraci√≥n de pasillo (Puertas)
        for (let i = 0; i < 6; i++) {
            let xPos = this.bgX + (i * 300);
            this.ctx.fillStyle = '#dfe4ea';
            this.ctx.fillRect(xPos, this.groundY - 180, 70, 180); // Puerta
            this.ctx.fillStyle = '#ced6e0';
            this.ctx.fillRect(xPos + 55, this.groundY - 100, 8, 8); // Pomo
        }

        // Suelo
        this.ctx.fillStyle = '#747d8c'; // Color cemento/clase
        this.ctx.fillRect(0, this.groundY, this.canvas.width, this.canvas.height - this.groundY);
        this.ctx.fillStyle = '#2f3542';
        this.ctx.fillRect(0, this.groundY, this.canvas.width, 4);
    }

    update() {
        this.score += 0.1;
        this.speed = this.baseSpeed + (this.score / 60); 
        document.getElementById('currentScore').innerText = Math.floor(this.score).toString().padStart(5, '0');

        this.player.dy += this.gravity;
        this.player.y += this.player.dy;

        if (this.player.y > this.groundY - this.player.h) {
            this.player.y = this.groundY - this.player.h;
            this.player.dy = 0;
            this.player.grounded = true;
            this.player.jumping = false;
        }

        // Obst√°culos
        let spawnRate = this.isMobile ? 0.04 : 0.03;
        let gap = this.isMobile ? 350 : 450;

        if (this.obstacles.length === 0 || (this.canvas.width - this.obstacles[this.obstacles.length-1].x) > gap) {
            if (Math.random() < spawnRate) {
                this.obstacles.push({
                    x: this.canvas.width,
                    y: this.groundY - 45,
                    w: 40, h: 40,
                    icon: ['üìö', 'üéí', 'üìù', 'üéì'][Math.floor(Math.random()*4)]
                });
            }
        }

        this.obstacles.forEach((obs, i) => {
            obs.x -= this.speed;
            // Colisi√≥n circular b√°sica
            let dx = (this.player.x + 27) - (obs.x + 20);
            let dy = (this.player.y + 27) - (obs.y + 20);
            let distance = Math.sqrt(dx * dx + dy * dy);
            if (distance < 35) this.gameOver();
            if (obs.x < -50) this.obstacles.splice(i, 1);
        });
    }

    draw() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.drawBackground();

        // Personaje
        this.ctx.save();
        this.ctx.beginPath();
        this.ctx.arc(this.player.x + 27, this.player.y + 27, 27, 0, Math.PI*2);
        this.ctx.clip();
        if (this.img && this.img.complete) {
            this.ctx.drawImage(this.img, this.player.x, this.player.y, 55, 55);
        }
        this.ctx.restore();
        this.ctx.strokeStyle = '#4834d4';
        this.ctx.lineWidth = 3;
        this.ctx.stroke();

        // Iconos
        this.ctx.font = '32px Arial';
        this.obstacles.forEach(obs => {
            this.ctx.fillText(obs.icon, obs.x, obs.y + 32);
        });
    }

    gameOver() {
        this.active = false;
        if (this.score > this.highScore) this.highScore = this.score;
        document.getElementById('highScore').innerText = Math.floor(this.highScore).toString().padStart(5, '0');
        document.getElementById('finalScoreText').innerText = `PUNTUACI√ìN: ${Math.floor(this.score)}`;
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('game-over-screen').style.display = 'block';
    }

    loop() {
        if (!this.active) return;
        this.update();
        this.draw();
        requestAnimationFrame(() => this.loop());
    }
}

// Iniciar
window.onload = () => { new Game(); };
</script>
{% endblock %}