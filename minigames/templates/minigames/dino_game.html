{% extends "base.html" %}
{% block title %}Dino Student Run{% endblock %}

{% block content %}
<div class="container py-4 text-center">
    <div class="d-flex justify-content-between align-items-center mb-4" style="max-width: 800px; margin: 0 auto;">
        <a href="{% url 'student_home' %}" class="btn btn-sm btn-outline-secondary border-0">
            <i class="fas fa-chevron-left"></i> Volver
        </a>
        <div class="d-flex gap-4">
            <div class="text-muted small text-uppercase fw-bold">HI <span id="highScore">00000</span></div>
            <div class="fw-bold text-dark text-uppercase">Score <span id="currentScore">00000</span></div>
        </div>
    </div>

    <div class="game-wrapper shadow-sm rounded">
        <canvas id="gameCanvas" width="800" height="200"></canvas>
        
        <div id="game-overlay" class="overlay">
            <div id="start-screen">
                <div class="mb-3">
                    <img src="{{ request.user.studentprofile.avatar.url|default:'https://cdn-icons-png.flaticon.com/512/194/194931.png' }}" 
                         id="playerSprite" class="rounded-circle border border-primary" style="width: 60px; height: 60px; object-fit: cover;">
                </div>
                <h4 class="fw-bold text-dark">Â¡ESQUIVA LOS LIBROS!</h4>
                <p class="text-muted small">Pulsa [Espacio] o Toca para saltar</p>
            </div>
            <div id="game-over-screen" style="display: none;">
                <h4 class="fw-bold text-danger mb-2">Â¡FIN DEL RECREO!</h4>
                <button onclick="game.reset()" class="btn btn-dark btn-sm px-4 rounded-pill">REINTENTAR</button>
            </div>
        </div>
    </div>
</div>

<style>
    .game-wrapper { position: relative; display: inline-block; background-color: #f7f7f7; border: 2px solid #eee; overflow: hidden; }
    canvas { max-width: 100%; height: auto; }
    .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; pointer-events: none; }
    #game-over-screen, #start-screen { pointer-events: auto; }
    #playerSprite { animation: bounce 1.5s infinite; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
</style>

<script>
class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.scoreElement = document.getElementById('currentScore');
        this.highScoreElement = document.getElementById('highScore');
        this.img = document.getElementById('playerSprite');
        
        this.player = {
            x: 50, y: 140, w: 45, h: 45,
            dy: 0, jumpForce: 13, gravity: 0.7,
            grounded: false
        };

        this.obstacles = [];
        this.score = 0;
        this.highScore = 0;
        this.speed = 6;
        this.active = false;
        this.lastTime = 0;
        
        this.init();
    }

    init() {
        const handler = (e) => {
            if (e.code === 'Space' || e.type === 'touchstart' || e.type === 'mousedown') {
                this.handleInput();
                if(e.code === 'Space') e.preventDefault();
            }
        };
        window.addEventListener('keydown', handler);
        this.canvas.addEventListener('mousedown', handler);
        this.canvas.addEventListener('touchstart', handler);
    }

    handleInput() {
        if (!this.active) this.start();
        else if (this.player.grounded) {
            this.player.dy = -this.player.jumpForce;
            this.player.grounded = false;
        }
    }

    start() {
        this.active = true;
        this.score = 0;
        this.speed = 6;
        this.obstacles = [];
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-over-screen').style.display = 'none';
        requestAnimationFrame((t) => this.loop(t));
    }

    spawnObstacle() {
        const icons = ['ðŸ“š', 'ðŸ“–', 'ðŸŽ’', 'ðŸ“'];
        const icon = icons[Math.floor(Math.random() * icons.length)];
        this.obstacles.push({ x: this.canvas.width, y: 155, w: 35, h: 35, icon: icon });
    }

    loop(timestamp) {
        if (!this.active) return;
        this.update();
        this.draw();
        requestAnimationFrame((t) => this.loop(t));
    }

    update() {
        this.score += 0.2;
        let currentScoreInt = Math.floor(this.score);
        this.scoreElement.innerText = currentScoreInt.toString().padStart(5, '0');

        // LÃ“GICA DE DIFICULTAD: Aumenta velocidad cada 100 puntos
        this.speed = 6 + Math.floor(currentScoreInt / 100) * 0.8;

        // FÃ­sica Jugador
        this.player.y += this.player.dy;
        if (this.player.y + this.player.h < 190) {
            this.player.dy += this.player.gravity;
            this.player.grounded = false;
        } else {
            this.player.y = 190 - this.player.h;
            this.player.dy = 0;
            this.player.grounded = true;
        }

        // ObstÃ¡culos
        if (this.obstacles.length === 0 || this.obstacles[this.obstacles.length-1].x < this.canvas.width - (350 - (this.speed * 5))) {
            if (Math.random() < 0.03) this.spawnObstacle();
        }

        this.obstacles.forEach((obs, i) => {
            obs.x -= this.speed;
            if (obs.x + obs.w < 0) this.obstacles.splice(i, 1);
            
            // ColisiÃ³n con el avatar circular
            if (this.player.x < obs.x + obs.w - 15 &&
                this.player.x + this.player.w - 15 > obs.x &&
                this.player.y < obs.y + obs.h - 10 &&
                this.player.y + this.player.h > obs.y + 10) {
                this.gameOver();
            }
        });
    }

    draw() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

        // Suelo
        this.ctx.strokeStyle = '#bbb';
        this.ctx.beginPath();
        this.ctx.moveTo(0, 190);
        this.ctx.lineTo(this.canvas.width, 190);
        this.ctx.stroke();

        // Dibujar Avatar del Alumno
        this.ctx.save();
        this.ctx.beginPath();
        this.ctx.arc(this.player.x + this.player.w/2, this.player.y + this.player.h/2, this.player.w/2, 0, Math.PI * 2);
        this.ctx.clip();
        this.ctx.drawImage(this.img, this.player.x, this.player.y, this.player.w, this.player.h);
        this.ctx.restore();
        // Borde del avatar
        this.ctx.strokeStyle = '#007bff';
        this.ctx.stroke();

        // ObstÃ¡culos
        this.ctx.font = '30px serif';
        this.obstacles.forEach(obs => {
            this.ctx.fillText(obs.icon, obs.x, obs.y + 25);
        });
    }

    gameOver() {
        this.active = false;
        if (this.score > this.highScore) {
            this.highScore = this.score;
            this.highScoreElement.innerText = Math.floor(this.highScore).toString().padStart(5, '0');
        }
        document.getElementById('game-over-screen').style.display = 'block';
    }

    reset() { this.start(); }
}

const game = new Game();
</script>
{% endblock %}