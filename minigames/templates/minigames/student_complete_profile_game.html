{% extends 'base.html' %}
{% load static %}
{# Fix variable rendering #}

{% block title %}Juego: Perfil Completo del Estudiante{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width: 600px;">

    <div class="text-center mb-4">
        <div class="d-inline-block px-4 py-2 bg-light rounded-pill border shadow-sm">
            <span class="text-muted small fw-bold text-uppercase me-2">Puntuación:</span>
            <span class="fw-bold" style="color: var(--color-blue-dark);">{{ correct }} / {{ total }}</span>
        </div>
    </div>

    <div class="card shadow-soft border-0 mb-4" style="border-radius: var(--border-radius-xl);">
        <div class="card-body p-4 text-center">
            <h3 class="mb-3 fw-bold" style="color: var(--color-blue-dark);">
                <i class="fas fa-user-graduate me-2"></i>¿Perfil Completo?
            </h3>
            <p class="text-muted small mb-4">Selecciona la ficha que corresponde a la foto.</p>

            <div class="position-relative d-inline-block">
                {% if target_student.profile_picture %}
                <img src="{{ target_student.profile_picture.url }}" alt="Foto del estudiante"
                    class="rounded-circle shadow"
                    style="width: 160px; height: 160px; object-fit: cover; border: 4px solid white; outline: 3px solid var(--color-blue-dark);">
                {% else %}
                <div class="bg-light rounded-circle shadow-sm d-flex align-items-center justify-content-center mx-auto"
                    style="width: 160px; height: 160px; border: 4px solid white; outline: 3px solid #dee2e6;">
                    <i class="fas fa-user fa-4x text-muted"></i>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <form method="post" id="gameForm" class="mt-4">
        {% csrf_token %}
        <div class="d-grid gap-3">
            {% for option in options %}
            <div class="card shadow-sm border-0 option-card" id="card-{{ option.student_id }}"
                onclick="selectOption('{{ option.student_id }}')"
                style="cursor: pointer; border-radius: var(--border-radius-lg); transition: all 0.2s ease;">

                <div class="card-body p-3">
                    <div class="d-flex align-items-center mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="selected_student_id"
                                value="{{ option.student_id }}" id="radio-{{ option.student_id }}"
                                style="transform: scale(1.2);">
                        </div>
                        <span class="ms-2 badge rounded-pill bg-light text-dark border">Opción {{ forloop.counter
                            }}</span>
                    </div>

                    <div class="student-info ps-4" style="font-size: 0.9rem;">
                        <p class="mb-1"><strong style="color: var(--color-blue-dark);">Nombre:</strong> {{
                            option.full_name }}</p>
                        <p class="mb-1"><strong>Apodo:</strong> <span class="text-muted">{{ option.nickname }}</span>
                        </p>
                        <p class="mb-1"><strong>Edad:</strong> <span class="text-muted">{{ option.age }} años</span></p>

                        <div class="my-2 p-2 bg-light rounded-3 small">
                            <div><i class="fas fa-music text-secondary me-1"></i> {{ option.favorite_artist }}</div>
                            <div><i class="fas fa-film text-secondary me-1"></i> {{ option.favorite_movie }}</div>
                        </div>

                        <div class="mt-2">
                            <span class="badge bg-primary rounded-pill me-1"
                                style="background-color: var(--color-blue-dark) !important;">Chapman: {{
                                option.chapman_result }}</span>
                            <span class="badge bg-success rounded-pill"
                                style="background-color: var(--color-green) !important;">VARK: {{ option.vark_result
                                }}</span>
                        </div>

                        <p class="mt-2 small text-muted fst-italic mb-0">
                            "{{ option.motivation|truncatechars:60 }}"
                        </p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-warning btn-lg px-5 text-white shadow rounded-pill btn-cta">
                <i class="fas fa-check-circle me-2"></i> Confirmar Elección
            </button>
        </div>
    </form>

    <div class="text-center mt-4 pt-3 border-top mb-5">
        <a href="{% url 'student_complete_profile_game' %}"
            class="btn btn-link text-decoration-none text-muted small me-2">
            <i class="fas fa-redo me-1"></i> Saltar
        </a>
        <a href="{% url 'teacher_home' %}" class="btn btn-outline-secondary btn-sm rounded-pill px-3">
            <i class="fas fa-home me-1"></i> Volver
        </a>
    </div>
</div>

<style>
    .option-card {
        border: 2px solid transparent !important;
        /* Default border */
        background: white;
    }

    .option-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-soft) !important;
    }

    .option-card.selected {
        border-color: var(--color-green) !important;
        background-color: #f0fdf4 !important;
        /* Very light green */
        box-shadow: 0 4px 12px rgba(26, 142, 83, 0.15) !important;
    }

    /* Ocultar el radio pero usarlo para logica si se desea, o estilizarlo */
    /* Aquí lo dejamos visible para claridad pero integrado */
</style>

<script>
    function selectOption(studentId) {
        // 1. Quitar clase 'selected' de todas las tarjetas
        document.querySelectorAll('.option-card').forEach(card => {
            card.classList.remove('selected');
        });

        // 2. Añadir clase 'selected' a la tarjeta actual
        const selectedCard = document.getElementById('card-' + studentId);
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }

        // 3. Marcar el radio button correspondiente
        const radio = document.getElementById('radio-' + studentId);
        if (radio) {
            radio.checked = true;
        }
    }

    // Permitir que hacer clic directamente en el radio también active la visualización
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('input[name="selected_student_id"]').forEach((radio) => {
            radio.addEventListener('change', function () {
                selectOption(this.value);
            });
        });
    });
</script>
{% endblock %}