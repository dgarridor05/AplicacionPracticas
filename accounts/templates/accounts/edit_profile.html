{% extends "base.html" %}
{% block title %}Editar perfil de alumno{% endblock %}

{% block content %}
  <div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
      <div class="card shadow-sm" style="border-radius: 15px;">
        <div class="card-body p-4">
          <h2 class="card-title mb-4 text-center fw-bold">Editar perfil de alumno</h2>

          <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            {% for field in form %}
              <div class="mb-3 position-relative">
                <label for="{{ field.id_for_label }}" class="form-label fw-bold">{{ field.label }}</label>
                {{ field }}
                {% if field.help_text %}
                  <div class="form-text text-muted small">{{ field.help_text }}</div>
                {% endif %}
                {% for error in field.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
            {% endfor %}

            <div class="d-flex justify-content-between mt-4">
              <a href="{% url 'student_home' %}" class="btn btn-outline-secondary px-4 rounded-pill">Volver</a>
              <button type="submit" class="btn btn-success px-4 rounded-pill shadow-sm">Guardar cambios</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <style>
    .autocomplete-results {
        position: absolute;
        z-index: 1050;
        background: white;
        border: 1px solid #ced4da;
        border-radius: 8px;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-top: 2px;
    }
    .result-item {
        padding: 10px 15px;
        cursor: pointer;
        font-size: 0.9rem;
        border-bottom: 1px solid #f8f9fa;
        transition: background 0.2s;
    }
    .result-item:last-child { border-bottom: none; }
    .result-item:hover { background-color: #f1f8f5; color: #198754; }
  </style>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
        // Buscamos el input por su atributo 'name' definido en forms.py
        const inputLugar = document.querySelector('input[name="favorite_place"]');
        
        if (inputLugar) {
            // Creamos el contenedor de resultados dinámicamente
            const resultsBox = document.createElement('div');
            resultsBox.className = 'autocomplete-results d-none';
            inputLugar.parentNode.appendChild(resultsBox);

            let debounceTimer;

            inputLugar.addEventListener('input', function() {
                clearTimeout(debounceTimer);
                const query = this.value;

                if (query.length < 3) {
                    resultsBox.classList.add('d-none');
                    return;
                }

                // Esperamos 400ms para no saturar la API gratuita
                debounceTimer = setTimeout(() => {
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`)
                        .then(response => response.json())
                        .then(data => {
                            resultsBox.innerHTML = '';
                            if (data.length > 0) {
                                resultsBox.classList.remove('d-none');
                                data.forEach(item => {
                                    const div = document.createElement('div');
                                    div.className = 'result-item';
                                    div.innerText = item.display_name;
                                    div.onclick = function() {
                                        inputLugar.value = item.display_name;
                                        resultsBox.classList.add('d-none');
                                    };
                                    resultsBox.appendChild(div);
                                });
                            } else {
                                resultsBox.classList.add('d-none');
                            }
                        })
                        .catch(err => console.error("Error en búsqueda:", err));
                }, 400);
            });

            // Cerrar el desplegable si se hace clic fuera del campo
            document.addEventListener('click', function(e) {
                if (!inputLugar.contains(e.target) && !resultsBox.contains(e.target)) {
                    resultsBox.classList.add('d-none');
                }
            });
        }
    });
  </script>
{% endblock %}